@model Scheduler.ViewModels.Test
@{
    ViewData["Title"] = "Home Page";
    var ci = new System.Globalization.CultureInfo("en-US");
}

@inject UserManager<ApplicationUser> UserManager


<h1>@ViewData["Message"]</h1>

@*<div id="alertmsg" class="alert alert-success" role="alert" style="display:none">
    Successfuly registred
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
</div>*@

<ul class="doctors">

    @foreach (var doctor in Model.Doctors)
    {
        <li>
            <div class="panel-group" id="accordion">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h4 class="panel-title">
                            <a data-toggle="collapse" data-parent="#accordion" href="#@doctor.Id">
                                <div class="image">
                                    <img width="64" height="64" src="/Home/ViewImage/@doctor.Id" />
                                </div>
                                <div class="details">
                                    <div class="Name" style="font-size:20px"><strong>@doctor.Name @doctor.Surname</strong></div>
                                    <div class="Scope">@doctor.Scope</div>
                                </div>
                            </a>
                        </h4>
                    </div>
                    <div id="@doctor.Id" class="panel-collapse collapse">
                        <div class="panel-body">
                            <div>Address: @doctor.Address - @doctor.Office</div>
                            <div>Phone: @doctor.PhoneNumber</div>

                            <br />

                            <div class="form-group">
                                <label>Select day:</label>
                                <select name="selectDay" id="selectDay-@doctor.Id" class="form-control" onchange="populate(@doctor.Id)">

                                    <option disabled selected value="">-- select day --</option>

                                    @for (int j = 0; j <= DateTime.DaysInMonth(DateTime.Now.Year, DateTime.Now.Month); j++)
                                    {
                                        @if ((DateTime.Now.AddDays(j).ToString("ddd", ci) == "Mon" && doctor.DoctorWorkHours.MondayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Tue" && doctor.DoctorWorkHours.TuesdayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Wed" && doctor.DoctorWorkHours.WednesdayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Thu" && doctor.DoctorWorkHours.ThursdayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Fri" && doctor.DoctorWorkHours.FridayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Sat" && doctor.DoctorWorkHours.SaturdayFrom != null) ||
                                        (DateTime.Now.AddDays(j).ToString("ddd", ci) == "Sun" && doctor.DoctorWorkHours.SundayFrom != null))
                                        {
                                            <option value="@DateTime.Now.AddDays(j).DayOfWeek.ToString("d")">
                                                @DateTime.Now.AddDays(j).DayOfWeek ( @DateTime.Now.AddDays(j).ToString("MM/dd") )
                                            </option>
                                        }

                                    }
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Select time:</label>
                                <select id="selectTime-@doctor.Id" class="form-control">
                                    <option disabled selected value="">-- select one --</option>
                                </select>
                            </div>

                            <button class="btn doctorn-default" onclick="register(@doctor.Id)">Register</button>
                        </div>
                    </div>
                </div>
            </div>
        </li>
    }

</ul>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script>
    function populate(doctorId) {

        $("#selectTime-" + doctorId).html("");

        $.getJSON("/Home/GetJson/", { DayId: $("#selectDay-" + doctorId).val(), doctorId: doctorId, day: $("#selectDay-" + doctorId + " option:selected").text().trim() }, function (data) {

            for (var obj in data) {
                $("#selectTime-" + doctorId).append("<option value='2'>" + data[obj].text + "</option>");
            }
        });
    }

    function register(doctorId) {

        var val = $("#selectDay-" + doctorId + " option:selected").text();
        var val2 = $("#selectTime-" + doctorId + " option:selected").text();

        $.post("/api/Appointments/Appointment", { doctorId: doctorId, day: val.toString(), time: val2.toString() })
            .done(function () {
                alert("You successfully registred on " + val.trim() + " at " + val2);
                //$('#alertmsg').show();
                populate(doctorId);
            }).fail(function () {
                alert("Something failed!");
            });

    }
</script>



